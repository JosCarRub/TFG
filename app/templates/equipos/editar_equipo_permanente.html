{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ titulo_pagina|default:"Editar Equipo" }} - De Rabona{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/equipo/editar_equipo_styles.css' %}">
{% endblock %}

{% block content %}
<div class="editar-equipo-container">
    <!-- Hero Section -->
    <div class="editar-equipo-hero animate-in">
        <div class="hero-content">
            <div class="current-team-info">
                <div class="current-shield">
                    {% if equipo.team_shield %}
                        <img src="{{ equipo.team_shield.url }}" alt="Escudo {{ equipo.nombre_equipo }}">
                    {% else %}
                        <div class="shield-placeholder">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="current-details">
                    <h1 class="current-name">{{ equipo.nombre_equipo }}</h1>
                    <p class="current-subtitle">Editando información del equipo</p>
                </div>
            </div>
            <div class="edit-icon">
                <i class="fas fa-edit"></i>
            </div>
        </div>
    </div>

    <!-- Mensajes del Sistema -->
    {% if messages %}
        <div class="messages-section">
            {% for message in messages %}
                <div class="custom-alert alert-{{ message.tags }}">
                    <div class="alert-icon">
                        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                    </div>
                    <div class="alert-content">{{ message }}</div>
                    <button type="button" class="alert-dismiss" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Formulario Principal -->
    <div class="editar-equipo-form-container animate-in">
        <form method="post" enctype="multipart/form-data" class="equipo-form" id="editarEquipoForm">
            {% csrf_token %}
            
            <div class="form-sections">
                <!-- Sección de información básica -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="section-content">
                            <h2 class="section-title">Información Básica</h2>
                            <p class="section-description">Modifica los datos principales de tu equipo</p>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <!-- Campo Nombre del Equipo (siempre primero) -->
                        {% for field in form %}
                            {% if field.name == 'nombre_equipo' %}
                                <div class="form-field">
                                    <label class="form-label" for="{{ field.id_for_label }}">
                                        <div class="label-content">
                                            <div class="label-icon">
                                                <i class="fas fa-tag"></i>
                                            </div>
                                            <span class="label-text">
                                                {{ field.label }}
                                                {% if field.field.required %}
                                                    <span class="required-asterisk">*</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </label>
                                    
                                    <div class="field-wrapper">
                                        {{ field }}
                                        <div class="field-status">
                                            <i class="fas fa-check-circle field-valid-icon"></i>
                                            <i class="fas fa-exclamation-circle field-invalid-icon"></i>
                                        </div>
                                    </div>
                                    
                                    {% if field.help_text %}
                                        <small class="form-help">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% if field.errors %}
                                        <div class="field-errors">
                                            {% for error in field.errors %}
                                                <small class="error-text">{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}

                        <!-- Campo Descripción (siempre segundo) -->
                        {% for field in form %}
                            {% if field.name == 'descripcion' %}
                                <div class="form-field form-field-full">
                                    <label class="form-label" for="{{ field.id_for_label }}">
                                        <div class="label-content">
                                            <div class="label-icon">
                                                <i class="fas fa-align-left"></i>
                                            </div>
                                            <span class="label-text">
                                                {{ field.label }}
                                                {% if field.field.required %}
                                                    <span class="required-asterisk">*</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </label>
                                    
                                    <div class="field-wrapper">
                                        {{ field }}
                                        <div class="field-status">
                                            <i class="fas fa-check-circle field-valid-icon"></i>
                                            <i class="fas fa-exclamation-circle field-invalid-icon"></i>
                                        </div>
                                    </div>
                                    
                                    {% if field.help_text %}
                                        <small class="form-help">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% if field.errors %}
                                        <div class="field-errors">
                                            {% for error in field.errors %}
                                                <small class="error-text">{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Sección de personalización visual -->
                <div class="form-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-palette"></i>
                        </div>
                        <div class="section-content">
                            <h2 class="section-title">Personalización Visual</h2>
                            <p class="section-description">Actualiza la identidad visual de tu equipo</p>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        {% for field in form %}
                            {% if field.name != 'nombre_equipo' and field.name != 'descripcion' %}
                                <div class="form-field {% if field.name == 'team_shield' or field.name == 'team_banner' %}form-field-full{% endif %}">
                                    <label class="form-label" for="{{ field.id_for_label }}">
                                        <div class="label-content">
                                            <div class="label-icon">
                                                {% if field.name == 'team_shield' %}
                                                    <i class="fas fa-shield-alt"></i>
                                                {% elif field.name == 'team_banner' %}
                                                    <i class="fas fa-image"></i>
                                                {% else %}
                                                    <i class="fas fa-cog"></i>
                                                {% endif %}
                                            </div>
                                            <span class="label-text">
                                                {{ field.label }}
                                                {% if field.field.required %}
                                                    <span class="required-asterisk">*</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </label>
                                    
                                    {% if field.name == 'team_shield' or field.name == 'team_banner' %}
                                        <div class="file-upload-container">
                                            <div class="file-upload-wrapper">
                                                <div class="file-input-container">
                                                    {{ field }}
                                                </div>
                                                {% if field.name == 'team_shield' and equipo.team_shield %}
                                                    <div class="current-file-info">
                                                        <div class="current-file-preview">
                                                            <img src="{{ equipo.team_shield.url }}" alt="Escudo actual">
                                                            <div class="current-badge">Actual</div>
                                                        </div>
                                                        <small class="file-info-text">
                                                            <i class="fas fa-info-circle"></i>
                                                            Selecciona un nuevo archivo para reemplazar el escudo actual
                                                        </small>
                                                    </div>
                                                {% elif field.name == 'team_banner' and equipo.team_banner %}
                                                    <div class="current-file-info">
                                                        <div class="current-file-preview">
                                                            <img src="{{ equipo.team_banner.url }}" alt="Banner actual">
                                                            <div class="current-badge">Actual</div>
                                                        </div>
                                                        <small class="file-info-text">
                                                            <i class="fas fa-info-circle"></i>
                                                            Selecciona un nuevo archivo para reemplazar el banner actual
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="field-wrapper">
                                            {{ field }}
                                        </div>
                                    {% endif %}
                                    
                                    {% if field.help_text %}
                                        <small class="form-help">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% if field.errors %}
                                        <div class="field-errors">
                                            {% for error in field.errors %}
                                                <small class="error-text">{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="form-actions animate-in">
                <a href="{% url 'detalle_equipo' pk=equipo.id_equipo %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    <span>Cancelar</span>
                </a>
                <button type="submit" class="btn btn-primary btn-submit">
                    <div class="btn-content">
                        <i class="fas fa-save btn-icon"></i>
                        <span class="btn-text">Guardar Cambios</span>
                    </div>
                    <div class="btn-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/equipo/editar_equipo.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animaciones de entrada
        const elements = document.querySelectorAll('.animate-in');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    setTimeout(() => {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }, index * 150);
                }
            });
        });
        
        elements.forEach(element => {
            element.style.opacity = '0';
            element.style.transform = 'translateY(30px)';
            element.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(element);
        });

        // Validación visual de campos
        const inputs = document.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                const wrapper = this.closest('.field-wrapper');
                if (wrapper) {
                    if (this.value.trim() !== '') {
                        wrapper.classList.add('valid');
                        wrapper.classList.remove('invalid');
                    } else if (this.hasAttribute('required')) {
                        wrapper.classList.add('invalid');
                        wrapper.classList.remove('valid');
                    }
                }
            });
        });

        // Manejo del formulario de envío
        const form = document.getElementById('editarEquipoForm');
        const submitBtn = document.querySelector('.btn-submit');
        
        if (form && submitBtn) {
            form.addEventListener('submit', function() {
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
            });
        }

        // Mejorar la experiencia de los campos de archivo
        const fileInputs = document.querySelectorAll('input[type="file"]');
        fileInputs.forEach(input => {
            input.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const fileName = this.files[0].name;
                    const wrapper = this.closest('.file-upload-wrapper');
                    let feedback = wrapper.querySelector('.file-selected-feedback');
                    
                    if (!feedback) {
                        feedback = document.createElement('div');
                        feedback.className = 'file-selected-feedback';
                        wrapper.appendChild(feedback);
                    }
                    
                    feedback.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <span>Archivo seleccionado: ${fileName}</span>
                    `;
                }
            });
        });
    });
</script>
{% endblock %}