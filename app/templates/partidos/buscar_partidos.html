{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo_pagina|default:"Buscar Partidos" }} - De Rabona{% endblock %}

{% block extra_css %}
<link href="{% static 'css/partidos/buscar_partidos_styles.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="buscar-container">
    <!-- Header Section -->
    <section class="header-section">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="header-text">
                <h1 class="header-title">{{ titulo_pagina|default:"Partidos Disponibles" }}</h1>
                <p class="header-subtitle">Encuentra tu próximo desafío futbolístico</p>
            </div>
        </div>
        
        <div class="header-actions">
            <a href="{% url 'crear_partidos' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                <span>Crear Partido</span>
            </a>
        </div>
    </section>

    <!-- Messages -->
    {% if messages %}
        <section class="messages-section">
            {% for message in messages %}
                <div class="message message-{{ message.tags }}">
                    <div class="message-content">
                        <p class="message-text">{{ message }}</p>
                        <button class="message-close" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        </section>
    {% endif %}

    <!-- Matches Section -->
    <section class="matches-section">
        {% if partidos_info_list %}
            <div class="matches-grid">
                {% for item_info in partidos_info_list %}
                    {% with partido=item_info.partido es_creador=item_info.es_creador esta_inscrito=item_info.esta_inscrito inscripcion_esta_abierta=item_info.inscripcion_esta_abierta plazas_disponibles=item_info.plazas_disponibles %}
                    <div class="match-card {% if es_creador %}match-card-owner{% elif esta_inscrito %}match-card-joined{% endif %}">
                        <!-- Card Header -->
                        <div class="card-header">
                            <div class="match-status">
                                {% if es_creador %}
                                    <span class="status-badge status-owner">Tu Partido</span>
                                {% elif esta_inscrito %}
                                    <span class="status-badge status-joined">Participando</span>
                                {% elif not inscripcion_esta_abierta and partido.jugadores.count >= partido.max_jugadores %}
                                    <span class="status-badge status-full">Completo</span>
                                {% elif not inscripcion_esta_abierta %}
                                    <span class="status-badge status-closed">Cerrado</span>
                                {% else %}
                                    <span class="status-badge status-available">Disponible</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Card Body -->
                        <div class="card-body">
                            <h3 class="match-title">
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="match-link">
                                    {{ partido.cancha.nombre_cancha }}
                                </a>
                            </h3>
                            
                            <div class="match-details">
                                <div class="detail-row">
                                    <div class="detail-item">
                                        <span class="detail-label">Fecha</span>
                                        <span class="detail-value">{{ partido.fecha|date:"d M, H:i" }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Límite</span>
                                        <span class="detail-value">{{ partido.fecha_limite_inscripcion_efectiva|date:"d/m H:i" }}</span>
                                    </div>
                                </div>
                                
                                <div class="detail-row">
                                    <div class="detail-item detail-location">
                                        <span class="detail-label">Ubicación</span>
                                        <span class="detail-value">{{ partido.cancha.ubicacion }}</span>
                                    </div>
                                </div>
                                
                                <div class="detail-row">
                                    <div class="detail-item">
                                        <span class="detail-label">Modalidad</span>
                                        <span class="detail-value">{{ partido.get_tipo_display }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Nivel</span>
                                        <span class="detail-value">{{ partido.get_nivel_display|default:"Abierto" }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Capacity -->
                            <div class="capacity-section">
                                <div class="capacity-header">
                                    <span class="capacity-label">Ocupación</span>
                                    <span class="capacity-count">{{ partido.jugadores.count }}/{{ partido.max_jugadores }}</span>
                                </div>
                                
                                <div class="capacity-bar">
                                    <div class="capacity-progress" style="width: {% widthratio partido.jugadores.count partido.max_jugadores 100 %}%"></div>
                                </div>
                                
                                <div class="capacity-status">
                                    {% if inscripcion_esta_abierta %}
                                        <span class="status-text status-available">{{ plazas_disponibles }} plazas disponibles</span>
                                    {% elif partido.jugadores.count >= partido.max_jugadores %}
                                        <span class="status-text status-full">Partido completo</span>
                                    {% else %}
                                        <span class="status-text status-closed">Inscripción cerrada</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card Footer -->
                        <div class="card-footer">
                            {% if es_creador %}
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="card-action btn-primary">
                                    <span>Gestionar Partido</span>
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                            {% elif esta_inscrito %}
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="card-action btn-secondary">
                                    <span>Ver Detalles</span>
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                            {% elif inscripcion_esta_abierta %}
                                <form action="{% url 'inscribirse_partido' partido_id=partido.id_partido %}" method="post" class="join-form">
                                    {% csrf_token %}
                                    <button type="submit" class="card-action btn-join">
                                        <span>Unirse al Partido</span>
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </form>
                            {% else %}
                                <div class="card-action btn-disabled">
                                    <span>No Disponible</span>
                                    <i class="fas fa-ban"></i>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
                <nav class="pagination-section">
                    <div class="pagination-content">
                        {% if page_obj.has_previous %}
                            <a href="?page=1" class="page-link">
                                <i class="fas fa-angle-double-left"></i>
                                <span>Primera</span>
                            </a>
                            <a href="?page={{ page_obj.previous_page_number }}" class="page-link">
                                <i class="fas fa-angle-left"></i>
                                <span>Anterior</span>
                            </a>
                        {% endif %}
                        
                        <div class="page-info">
                            <span class="current-page">{{ page_obj.number }}</span>
                            <span class="page-separator">de</span>
                            <span class="total-pages">{{ page_obj.paginator.num_pages }}</span>
                        </div>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}" class="page-link">
                                <span>Siguiente</span>
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ page_obj.paginator.num_pages }}" class="page-link">
                                <span>Última</span>
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% endif %}
                    </div>
                </nav>
            {% endif %}
        {% else %}
            <!-- Empty State -->
            <section class="empty-section">
                <div class="empty-content">
                    <div class="empty-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="empty-text">
                        <h3 class="empty-title">No se encontraron partidos</h3>
                        <p class="empty-description">
                            No hay partidos disponibles que coincidan con tus criterios actuales.
                            ¿Por qué no crear el primero?
                        </p>
                    </div>
                    <div class="empty-actions">
                        <a href="{% url 'crear_partidos' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            <span>Crear Primer Partido</span>
                        </a>
                        <a href="{% url 'buscar_partidos' %}" class="btn btn-secondary">
                            <i class="fas fa-refresh"></i>
                            <span>Actualizar Búsqueda</span>
                        </a>
                    </div>
                </div>
            </section>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones sutiles
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.classList.add('animate-in');
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    // Observar elementos
    document.querySelectorAll('.match-card').forEach(card => {
        observer.observe(card);
    });

    // Confirmación de inscripción
    document.querySelectorAll('.join-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const confirmation = confirm('¿Confirmas tu participación en este partido?');
            
            if (confirmation) {
                const button = this.querySelector('.btn-join');
                button.innerHTML = '<span>Inscribiendo...</span><i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;
                
                this.submit();
            }
        });
    });
});
</script>
{% endblock %}