{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo_pagina|default:"Buscar Partidos" }} - De Rabona{% endblock %}

{% block extra_css %}
<link href="{% static 'css/partidos/buscar_partidos_styles.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="partidos-container" id="buscar-partidos-container">
    <!-- Hero Section -->
    <section class="partidos-hero-section" id="buscar-hero-section">
        <div class="hero-content">
            <div class="hero-icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="hero-text">
                <h1 class="hero-title">{{ titulo_pagina|default:"Partidos Disponibles" }}</h1>
                <p class="hero-subtitle">Asómate a la ventana y busca si están los chavales en las pistas</p>
            </div>
        </div>
        
        <div class="header-actions">
            <a href="{% url 'crear_partidos' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                <span>Crear Partido</span>
            </a>
        </div>
    </section>

    <!-- Messages -->
    {% if messages %}
        <section class="messages-section" id="buscar-messages-section">
            {% for message in messages %}
                <div class="custom-alert alert-{{ message.tags }}">
                    <div class="alert-icon">
                        {% if message.tags == 'success' %}
                            <i class="fas fa-check-circle"></i>
                        {% elif message.tags == 'error' or message.tags == 'danger' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% elif message.tags == 'warning' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% else %}
                            <i class="fas fa-info-circle"></i>
                        {% endif %}
                    </div>
                    <div class="alert-content">{{ message }}</div>
                    <button class="alert-dismiss" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endfor %}
        </section>
    {% endif %}

    <!-- Stats Section -->
    {% if partidos_info_list %}
        <section class="stats-section" id="buscar-stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-futbol"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ partidos_info_list|length }}</div>
                        <div class="stat-label">Partidos Disponibles</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% for item in partidos_info_list %}{{ item.partido.jugadores.count|add:0 }}{% if not forloop.last %} + {% endif %}{% endfor %}
                        </div>
                        <div class="stat-label">Jugadores Inscritos</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% regroup partidos_info_list by partido.cancha.ubicacion as ubicaciones %}
                            {{ ubicaciones|length }}
                        </div>
                        <div class="stat-label">Ubicaciones</div>
                    </div>
                </div>
            </div>
        </section>
    {% endif %}

    <!-- Partidos Section -->
    <section class="partidos-section" id="buscar-partidos-section">
        {% if partidos_info_list %}
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    Próximos Partidos
                </h2>
                <div class="section-meta">
                    <span class="partidos-count">{{ partidos_info_list|length }} partido{{ partidos_info_list|length|pluralize:"s" }}</span>
                </div>
            </div>
            
            <div class="partidos-grid">
                {% for item_info in partidos_info_list %}
                    {% with partido=item_info.partido es_creador=item_info.es_creador esta_inscrito=item_info.esta_inscrito inscripcion_esta_abierta=item_info.inscripcion_esta_abierta plazas_disponibles=item_info.plazas_disponibles %}
                    <div class="partido-card {% if es_creador %}partido-owner{% elif esta_inscrito %}partido-joined{% endif %}">
                        <!-- Partido Header -->
                        <div class="partido-header">
                            <div class="partido-status">
                                {% if es_creador %}
                                    <span class="status-badge status-owner">
                                        <i class="fas fa-crown"></i>
                                        Tu Partido
                                    </span>
                                {% elif esta_inscrito %}
                                    <span class="status-badge status-joined">
                                        <i class="fas fa-check"></i>
                                        Participando
                                    </span>
                                {% elif not inscripcion_esta_abierta and partido.jugadores.count >= partido.max_jugadores %}
                                    <span class="status-badge status-full">
                                        <i class="fas fa-users"></i>
                                        Completo
                                    </span>
                                {% elif not inscripcion_esta_abierta %}
                                    <span class="status-badge status-closed">
                                        <i class="fas fa-lock"></i>
                                        Cerrado
                                    </span>
                                {% else %}
                                    <span class="status-badge status-available">
                                        <i class="fas fa-clock"></i>
                                        Disponible
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="partido-capacity">
                                <span class="capacity-text">{{ partido.jugadores.count }}/{{ partido.max_jugadores }}</span>
                                <div class="capacity-bar">
                                    <div class="capacity-fill" style="width: {% widthratio partido.jugadores.count partido.max_jugadores 100 %}%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Partido Content -->
                        <div class="partido-content">
                            <h3 class="partido-title">
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="partido-link">
                                    {{ partido.cancha.nombre_cancha }}
                                </a>
                            </h3>
                            
                            <div class="partido-details">
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                    <div class="info-text">
                                        <div class="info-label">Fecha y Hora</div>
                                        <div class="info-value">{{ partido.fecha|date:"d M Y, H:i" }}h</div>
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="info-text">
                                        <div class="info-label">Límite Inscripción</div>
                                        <div class="info-value">{{ partido.fecha_limite_inscripcion_efectiva|date:"d/m H:i" }}h</div>
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="info-text">
                                        <div class="info-label">Ubicación</div>
                                        <div class="info-value">{{ partido.cancha.ubicacion }}</div>
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-futbol"></i>
                                    </div>
                                    <div class="info-text">
                                        <div class="info-label">Modalidad</div>
                                        <div class="info-value">{{ partido.get_tipo_display }}</div>
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <div class="info-icon">
                                        <i class="fas fa-signal"></i>
                                    </div>
                                    <div class="info-text">
                                        <div class="info-label">Nivel</div>
                                        <div class="info-value">{{ partido.get_nivel_display|default:"Abierto" }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Partido Actions -->
                        <div class="partido-actions">
                            {% if es_creador %}
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="btn btn-primary">
                                    <i class="fas fa-cog"></i>
                                    <span>Gestionar</span>
                                </a>
                            {% elif esta_inscrito %}
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="btn btn-secondary">
                                    <i class="fas fa-eye"></i>
                                    <span>Ver Detalles</span>
                                </a>
                            {% elif inscripcion_esta_abierta %}
                                <form action="{% url 'inscribirse_partido' partido_id=partido.id_partido %}" method="post" class="join-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-user-plus"></i>
                                        <span>Unirse</span>
                                    </button>
                                </form>
                            {% else %}
                                <div class="btn btn-disabled">
                                    <i class="fas fa-ban"></i>
                                    <span>No Disponible</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
                <nav class="pagination-section" id="buscar-pagination">
                    <div class="pagination-content">
                        {% if page_obj.has_previous %}
                            <a href="?page=1" class="page-link">
                                <i class="fas fa-angle-double-left"></i>
                                <span>Primera</span>
                            </a>
                            <a href="?page={{ page_obj.previous_page_number }}" class="page-link">
                                <i class="fas fa-angle-left"></i>
                                <span>Anterior</span>
                            </a>
                        {% endif %}
                        
                        <div class="page-info">
                            <span class="current-page">{{ page_obj.number }}</span>
                            <span class="page-separator">de</span>
                            <span class="total-pages">{{ page_obj.paginator.num_pages }}</span>
                        </div>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}" class="page-link">
                                <span>Siguiente</span>
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ page_obj.paginator.num_pages }}" class="page-link">
                                <span>Última</span>
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% endif %}
                    </div>
                </nav>
            {% endif %}
        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="empty-content">
                    <h3 class="empty-title">No se encontraron partidos</h3>
                    <p class="empty-desc">
                        No hay partidos disponibles que coincidan con tus criterios actuales.
                        ¿Por qué no crear el primero?
                    </p>
                    <div class="empty-actions">
                        <a href="{% url 'crear_partidos' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            <span>Crear Primer Partido</span>
                        </a>
                        <a href="{% url 'buscar_partidos' %}" class="btn btn-secondary">
                            <i class="fas fa-refresh"></i>
                            <span>Actualizar Búsqueda</span>
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones de entrada
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.classList.add('animate-in');
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    // Observar cards
    document.querySelectorAll('.partido-card').forEach(card => {
        observer.observe(card);
    });

    // Confirmación de inscripción
    document.querySelectorAll('.join-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const confirmation = confirm('¿Confirmas tu participación en este partido?');
            
            if (confirmation) {
                const button = this.querySelector('.btn');
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Inscribiendo...</span>';
                button.disabled = true;
                
                setTimeout(() => {
                    this.submit();
                }, 500);
            }
        });
    });

    // Auto-dismiss alerts
    setTimeout(() => {
        document.querySelectorAll('.custom-alert').forEach(alert => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(() => alert.remove(), 300);
        });
    }, 5000);
});
</script>
{% endblock %}